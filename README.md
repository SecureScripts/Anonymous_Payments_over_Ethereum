# Anonymous_Payments_over_Ethereum

This repository contains the full implementation and experimental framework used in the paper:

**F. Buccafurri, V. De Angelis, S. Lazzaro**  
*Network-Layer Anonymous Payments over Ethereum via Cover Transactions*, TO APPEAR, 2025.

The repository provides:
- A simulator implementing the anonymous payment protocol described in the paper  
- Execution-based smart contract gas-cost profiling using Ganache  
- Preprocessing tools for user payment datasets  
- Automated simulation campaigns  
- Plot generation scripts that reproduce all figures in the publication  

---

## Repository Structure

```
Simulation/
└── Blockchain_BUS/
    ├── User.py
    │   # User model: payment scheduling, collaboration behavior, expenses,
    │   # waiting time statistics, and incentive-related state.
    │
    ├── BlockchainRing.py
    │   # Core simulator of the ring-based anonymous payment protocol.
    │   # Handles bus circulation, payment execution, confirmations,
    │   # epoch management, and deposit redistribution.
    │
    ├── SuperMain.py
    │   # Main simulation campaign.
    │   # Loads datasets and gas-cost profiles, runs multiple simulations
    │   # across parameter configurations, and produces simulation_results.csv.
    │
    └── simulation_results.csv
        # (after launching SuperMain.py) Output file generated by SuperMain.py.
        # Contains aggregated metrics used for plotting and analysis.


Price_Estimate/
├── Average_wei_dollars_estimation.py
│   # Computes the average gas price (wei per gas unit) and the average
│   # Ether price (USD per ETH) for year 2024, and derives USD-per-gas.
│
├── export-AvgGasPrice.csv
│   # Historical average gas price data (wei per gas unit).
│
└── export-EtherPrice.csv
    # Historical Ether price data (USD per ETH).


Data_for_simulation/
├── Extract_Blockchain_Operation_Cost/
│   ├── GanacheSimulationCosts.py
│   │   # Deploys the smart contract on a local Ganache instance and
│   │   # measures execution gas costs for startConfirm(), confirm(),
│   │   # setConfirm(), and pay() under different workloads.
│   │
│   └── FINAL_RES.csv
│       # Gas-cost measurements extracted from Ganache.
│       # Used by the simulator to model realistic on-chain costs.
│
└── Extract_User_Payments_Data/
    ├── first_dataset_preprocess.py
    │   # Initial preprocessing of the IBM credit card dataset
    │   # (credit_card_transactions-ibm_v2.csv).
    │   # Filters transactions and produces per-user (timestamp, amount) pairs.
    │
    ├── final_dataset_creation.py
    │   # Creates the final wallet-capped dataset used by the simulator.
    │   # Selects top users, enforces equal wallet size, and generates
    │   # CDF CSV files and optional PDF plots.
    │
    ├── generateCDF.py
    │   # Generates CDF plots from precomputed CSV files
    │   # (amounts and mean interpayment times).
    │
    ├── user_transaction_pairs.csv
    │   # (after launching first_dataset_preprocess.py)
    │   # Per-user list of (timestamp_ms, amount) pairs.
    │
    └── output_selection_2020/
        ├── filtered_dataset.csv
        │   # Final wallet-capped dataset used by SuperMain.py.
        │
        ├── cdf_amounts_new.csv
        ├── cdf_amounts_original2020.csv
        ├── cdf_mean_interpayment_hours_new.csv
        ├── cdf_mean_interpayment_hours_original2020.csv
        │   # CSV files containing empirical CDF curves.
        │
        └── *.pdf
            # (after launching generateCDF.py)
            # PDF plots comparing original vs wallet-capped datasets.


Final_Plots/
├── HeatmapPlots.py
│   # Generates heatmaps and waiting-time plots from simulation_results.csv.
│   # These figures correspond to the main experimental results in the paper.
│
├── ExpensesPlot.py
│   # Generates expense-vs-waiting-time plots for fully cooperative users.
│
└── *.pdf / *.png
    # (after launching HeatmapPlots.py and ExpensesPlot.py) Final figures produced from the simulation output.
```

---

## Requirements

- Python **3.10+**
- Ganache (CLI or GUI)
- Node.js (optional, only if installing Ganache CLI)
- Python packages (installed via `requirements.txt`)

---

## Installation

```bash
python -m venv venv
# source venv/bin/activate        # Linux / macOS
venv\Scripts\activate.bat     # Windows

pip install -r requirements.txt  # Install dependencies
```

Ensure Ganache is running and its RPC URL matches the one defined in `Parameters.py`.

---

## Usage

The experimental workflow is composed of four main stages:

1. Pre-compute input data (gas price, Ether price, and blockchain operation costs)  
2. Preprocess the payment dataset  
3. Run the main simulation  
4. Generate the plots used in the paper  

Each step is described in detail below.

---

### 1. Pre-compute Input Data

#### 1.1 Average gas price and Ether price (2024)

The script in `Price_Estimate/` computes the average cost of one gas unit in USD
for the year 2024.

From the project root:

```bash
cd Price_Estimate
python Average_wei_dollars_estimation.py
```

This script reads the following input files:

- `export-AvgGasPrice.csv` — average gas price (wei per gas unit)
- `export-EtherPrice.csv` — average Ether price (USD per ETH)

and computes the average **USD-per-gas** value.

⚠️ **Important note**  
The resulting value is already set in `SuperMain.py` as the constant:

```python
GAS_IN_DOLLARS = ...
```

If the gas price estimation is recomputed using updated data, this value must be
manually updated in `SuperMain.py` before running the simulation.


#### 1.2 Blockchain operation costs via Ganache

The script `GanacheSimulationCosts.py` measures the execution gas costs of the
smart contract functions used by the protocol.

From the project root:

```bash
cd Data_for_simulation/Extract_Blockchain_Operation_Cost
python GanacheSimulationCosts.py
```

Requirements:
- A local Ganache instance must be running
- The smart contract implementing the protocol must be available
  in the same folder (used only for gas-cost profiling)

This script:
- Deploys the smart contract on Ganache
- Executes `startConfirm()`, `confirm()`, `setConfirm()`, `pay()`, and `depositBack()`
  for different workloads
- Produces the file:

```
FINAL_RES.csv
```

which is later loaded by `SuperMain.py` to model realistic blockchain costs.

---

### 2. Payment Dataset Preprocessing

The payment traces used by the simulator are derived from the **IBM Credit Card
Transactions Dataset**.

#### 2.1 Download the dataset

The raw dataset is not included in this repository due to its size (~2 GB).

It can be downloaded from Kaggle:

```
https://www.kaggle.com/datasets/ibm/credit-card-transactions
```

After downloading, place the file:

```
credit_card_transactions-ibm_v2.csv
```

inside the folder:

```
Data_for_simulation/Extract_User_Payments_Data/
```


#### 2.2 Initial preprocessing

This step filters the raw dataset and extracts per-user payment traces.

From the project root:

```bash
cd Data_for_simulation/Extract_User_Payments_Data
python first_dataset_preprocess.py
```

This script:
- Removes fraudulent and erroneous transactions
- Filters out negative amounts
- Converts dates to UNIX timestamps (milliseconds)
- Produces:

```
user_transaction_pairs.csv
```

containing, for each user, a list of `(timestamp_ms, amount)` pairs.


#### 2.3 CDF plots for dataset characterization (Figures 3 and 4)

The following script generates the CDF plots used to characterize the dataset
in the paper (Figures 3 and 4).

```bash
python generateCDF.py
```

This script reads precomputed CSV files and generates PDF figures comparing:
- payment amount distributions
- mean interpayment time distributions


#### 2.4 Final dataset creation (wallet-capped users, year 2020)

The final dataset used by the simulator is created with:

```bash
python final_dataset_creation.py
```

This script:
- Selects users with activity in year 2020
- Keeps the top users by total spending
- Enforces an equal wallet size for all selected users
- Generates the final dataset:

```
output_selection_2020/filtered_dataset.csv
```

This file is the **input dataset used by `SuperMain.py`**.

---

### 3. Run the Main Simulation

The core experimental results of the paper are produced by running the simulator.

From the project root:

```bash
cd Simulation/Blockchain_BUS
python SuperMain.py
```

This script:
- Loads the wallet-capped 2020 dataset
- Loads blockchain gas-cost profiles from `FINAL_RES.csv`
- Simulates multiple rings under different configurations:
  - bus hop time
  - initial deposit size
  - collaboration level of non-cooperative users
- Runs multiple repetitions for statistical robustness

At the end, it produces:

```
simulation_results.csv
```

which contains all aggregated metrics used for plotting and analysis.

---

### 4. Generate Final Plots (Figures 5–9)

The plots presented in the paper are generated from `simulation_results.csv`.

#### 4.1 Heatmaps and waiting-time plots (Figures 5–8)

From the project root:

```bash
cd Final_Plots
python HeatmapPlots.py
```

This script generates:
- Heatmaps of expense differences (non-cooperative vs cooperative users)
- Waiting-time plots as a function of bus hop time

These figures correspond to **Figures 5–8** in the paper.


#### 4.2 Expense vs waiting-time plot (Figure 9)

From the same folder:

```bash
python ExpensesPlot.py
```

This script generates the plot showing expenses (as a percentage of the wallet)
versus mean waiting time for fully cooperative users.

This corresponds to **Figure 9** in the paper.

All figures are saved in the `Final_Plots/` directory.


---

## Citation

```
@article{anonymous_payments_bus_2025,
  title={Network-Layer Anonymous Payments over Ethereum via Cover Transactions},
  author={Buccafurri, Francesco and De Angelis, Vincenzo and Lazzaro, Sara},
  journal={TO APPEAR},
  year={2025}
}
```

---

## Contributing

Pull requests, suggestions, and bug reports are welcome.

---

## Contact

For questions regarding the paper or implementation, please contact the authors.
